<html>
    <script src="https://cdn.staticfile.org/jquery/1.10.2/jquery.min.js"></script>
    <script>
        cID=3;
        let dish;
        document.ready=function(){
            $.ajax({type:'GET',url:"http://localhost:5000/api/com/dish",async :false,
        success:(res)=>{ 
            //console.log(res);
             dish=res;
                        } 
        })
        for(let i in dish){
            var newdish=document.createElement("div");
            newdish.setAttribute("id",dish[i].id);
            newdish.setAttribute("class","dish");
            var newdishname=document.createElement("a");
            newdishname.innerHTML=dish[i].name;
            var newdishcomment=document.createElement("div");
            newdishcomment.setAttribute("class","Comment");
            var newbutton=document.createElement("button");
            newbutton.addEventListener("click",function(){addComment(this)},false);
            newbutton.setAttribute("class","addCom");
            newbutton.innerHTML="add";
            var newadd=document.createElement("div");
            newadd.setAttribute("class","add");
            newadd.setAttribute("hidden",true);
            var inputplace=document.createElement("input");
            inputplace.setAttribute("minlength",1);
            inputplace.setAttribute("type","text");
            var submitb=document.createElement("button");
            submitb.innerHTML="submit";
            submitb.addEventListener("click",function(){submitComment(this)},false);
            newadd.append(inputplace);
            newadd.append(submitb);
            newdish.append(newdishname);
            newdish.append(newdishcomment);
            newdish.append(newbutton);
            newdish.append(newadd);
            document.getElementById("dish").append(newdish);
            $.ajax({type:'GET',url:"http://localhost:5000/api/com/comment/"+dish[i].id,async:false,
        success:(res)=>{
                console.log(res);
                for(let j in res){
                    //console.log(res[j].id);
                    var newd=document.createElement("div");
                    var newa=document.createElement("a");
                    var newb=document.createElement("button");
                    var newb2=document.createElement("button");
                    newd.appendChild(newa);
                    newd.appendChild(newb);
                    newd.appendChild(newb2);
                    var commentArea=document.getElementById(dish[i].id).getElementsByClassName("Comment")[0];
                    var ComId="D"+dish[i].id+"C"+res[j].id;
                    newd.setAttribute("id",ComId);
                    newd.getElementsByTagName('a')[0].innerHTML=res[j].content;
                    newd.getElementsByTagName('button')[0].innerHTML="helpful:"+res[j].likeNum;
                    newd.getElementsByTagName('button')[0].addEventListener("click",function(){likeComment(this)},false);
                    newd.getElementsByTagName('button')[1].innerHTML="delete";
                    newd.getElementsByTagName('button')[1].addEventListener("click",function(){deleteComment(this)},false);
                    commentArea.appendChild(newd);
                        
        }
        }
    
        })
    }
}
        function addComment(ele){
            var dishId=ele.parentNode.id;
            let blc=document.getElementById(dishId).getElementsByClassName("add")[0];
            blc.removeAttribute("hidden");
        }
        function submitComment(ele){
            var dishId=ele.parentNode.parentNode.id;
            let input=document.getElementById(dishId).getElementsByTagName("input")[0].value;
            //alert(input)
            let blc=document.getElementById(dishId).getElementsByClassName("add")[0];
            blc.hidden=true;
            let id=0;
            //ajax use input, dishId, commentId
            $.ajax({type:'POST',url:"http://localhost:5000/api/com/addC/cid/"+cID+"/dishId/"+dishId+"/content/"+input,async :false,
        success:(res)=>{ 
            id=res[0].MI+1;
             //console.log(res.cid);
                        } 
        })
            var ComId="D"+dishId+"C"+id;
            var newd=document.createElement("div");
            var newa=document.createElement("a");
            var newb=document.createElement("button");
            var newb2=document.createElement("button");
            newd.appendChild(newa);
            newd.appendChild(newb);
            newd.appendChild(newb2);
            var commentArea=document.getElementById(dishId).getElementsByClassName("Comment")[0];
            
            newd.id=ComId;
            newd.getElementsByTagName('a')[0].innerHTML=input;
            newd.getElementsByTagName('button')[0].innerHTML="helpful:0";
            newd.getElementsByTagName('button')[0].addEventListener("click",function(){likeComment(this)},false);
            newd.getElementsByTagName('button')[1].innerHTML="delete";
            newd.getElementsByTagName('button')[1].addEventListener("click",function(){deleteComment(this)},false);
            commentArea.appendChild(newd);
        }
        function likeComment(ele){
            var cid=ele.parentNode.id;
            var str=cid.substring(3);
            var CID=parseInt(str)
            $.ajax({type:'POST',url:"http://localhost:5000/api/com/like/"+CID, async:false,
        success:(res)=>{
            var num=res[0].LN;
            document.getElementById(cid).getElementsByTagName('button')[0].innerHTML="helpful:"+num;
        }
        })
        }
        function deleteComment(ele){
            var cid=ele.parentNode.id;
            var CID=cid.substring(3);
            $.ajax({type:'POST',url:"http://localhost:5000/api/com/deleteC/"+CID+"/"+cID, async: false,
            success:(res)=>{
                console.log("result : "+res);
                if(!res){
                    alert("u can only delete your own comments!");
                }
                else{
                    document.getElementById(cid).remove();
                }
            }
          });
          
        }
    </script>
    <head>
        
    </head>
    <body>
        <div id="dish">
            
        </div>
    </body>
</html>
