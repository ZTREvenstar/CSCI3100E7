<html>
    <script src="https://cdn.staticfile.org/jquery/1.10.2/jquery.min.js"></script>
    <script>
        cID=5;
        let dish;
        document.ready=function(){
            $.ajax({type:'GET',url:"http://localhost:3000/dish",async :false,
        success:(res)=>{ 
             dish=res.dish;
                        } 
        })
        for(let i in dish){
            $.ajax({type:'GET',url:"http://localhost:3000/comment/"+dish[i],async:false,
        success:(res)=>{
                for(let j in res){
                    //console.log(res[j].id);
                    var newd=document.createElement("div");
                    var newa=document.createElement("a");
                    var newb=document.createElement("button");
                    var newb2=document.createElement("button");
                    newd.appendChild(newa);
                    newd.appendChild(newb);
                    newd.appendChild(newb2);
                    var commentArea=document.getElementById(dish[i]).getElementsByClassName("Comment")[0];
                    var ComId="D"+dish[i]+"C"+res[j].id;
                    newd.id=ComId;
                    newd.getElementsByTagName('a')[0].innerHTML=res[j].content;
                    newd.getElementsByTagName('button')[0].innerHTML="helpful:"+res[j].likeNum;
                    //newd.getElementsByTagName('button')[0].onclick=function(event){
                    //console.log(ComId);
                    //likeComment();
                    //                                                             };
                    newd.getElementsByTagName('button')[1].innerHTML="delete";
                    //newd.getElementsByTagName('button')[1].onclick=function(event){
                       // console.log(ComId);
                       // deleteComment(newd.id);
                       //                                                              };
                       commentArea.appendChild(newd);
                                 }
                        }
        })
        }
        
        }
        
        function addComment(dishId){
            let blc=document.getElementById(dishId).getElementsByClassName("add")[0];
            blc.removeAttribute("hidden");
        }
        function submitComment(dishId){
            let input=document.getElementById(dishId).getElementsByTagName("input")[0].value;
            //alert(input)
            let blc=document.getElementById(dishId).getElementsByClassName("add")[0];
            blc.hidden=true;
            let id=0;
            //ajax use input, dishId, commentId
            $.ajax({type:'POST',url:"http://localhost:3000/addC/cid/"+cID+"/dishId/"+dishId+"/content/"+input,async :false,
        success:(res)=>{ 
            id=res.cid;
             //console.log(res.cid);
                        } 
        })
            var ComId="D"+dishId+"C"+id;
            var newd=document.createElement("div");
            var newa=document.createElement("a");
            var newb=document.createElement("button");
            var newb2=document.createElement("button");
            newd.appendChild(newa);
            newd.appendChild(newb);
            newd.appendChild(newb2);
            var commentArea=document.getElementById(dishId).getElementsByClassName("Comment")[0];
            commentArea.appendChild(newd);
            newd.id=ComId;
            newd.getElementsByTagName('a')[0].innerHTML=input;
            newd.getElementsByTagName('button')[0].innerHTML="helpful:0";
            newd.getElementsByTagName('button')[0].onclick=function(event){
                likeComment(ComId);
            };
            newd.getElementsByTagName('button')[1].innerHTML="delete";
            newd.getElementsByTagName('button')[1].onclick=function(event){
                deleteComment(ComId);
            };
        }
        function likeComment(cid){
            var str=cid.substring(3);
            var CID=parseInt(str)
            $.ajax({type:'POST',url:"http://localhost:3000/like/"+CID, async:false,
        success:(res)=>{
            var num=res[0].likeNum;
            document.getElementById(cid).getElementsByTagName('button')[0].innerHTML="helpful:"+num;
        }
        })
        }
        function deleteComment(cid){
            var CID=cid.substring(3);
            $.ajax({type:'POST',url:"http://localhost:3000/deleteC/"+CID, async: false,
            success:(res)=>{
                console.log(res);
            }
          });
          document.getElementById(cid).remove();
        }
    </script>
    <head>

    </head>
    <body>
        <div id="dish">
            <div id="1" class="dish">
                <a>水煮牛肉</a>
                <div class="Comment">
                    <div id="D1C1">
                        <a>it is really nice and cheap</a>
                        <button onclick="likeComment('D1C1')">helpful:0</button>
                    </div>
                </div>
                <button onclick="addComment('1')" class="addCom">add</button>
                <div class="add" hidden>
                    <input type="text" required minlength="1" size="30">
                    <button onclick="submitComment(1)">submit</button>
                </div>
                
            </div>
        </div>
    </body>
</html>
